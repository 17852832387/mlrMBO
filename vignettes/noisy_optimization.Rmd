---
title: "Noisy Optimization"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: false
vignette: >
  %\VignetteIndexEntry{Noisy Optimization}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE, cache = FALSE}
library(mlrMBO)
set.seed(1)
knitr::opts_chunk$set(cache = TRUE, collapse = FALSE, results = 'hold')
knitr::knit_hooks$set(document = function(x){
  gsub("```\n*```r*\n*", "", x)
})
```

## Purpose

This vignette will give you a short overview about techniques in **mlrMBO** to handle optimization of noisy objective functions.

## Infill criteria for noiy optimization

Like always let's start with the function we want to optimize, but this time it will be noisy and even heteroscedastic.

```{r objective_function}
library(mlrMBO)
library(ggplot2)
fun = function(x) {
  rnorm(1, mean = x^2, sd = 0.5 + 0.75* x+5)
}
obj.fun = makeSingleObjectiveFunction(name = "noisy_parable", fn = fun, has.simple.signature = TRUE, par.set = makeNumericParamSet("x", 1, -5, 5), noisy = TRUE)
# visualize the function
autoplot(obj.fun, render.levels = TRUE, show.optimum = TRUE)
```

As you can see the function is more noisy for large values of `x` so that the true optimum at `x=0` appears to be hidden.

```{r control}
ctrl = makeMBOControl(final.method = "best.predicted", final.evals = 10)
```

For noisy optimization we there are two infill.criteria that are recomended:
* `aei`: Augmented Expected Improvement
* `eqi`: Expected Quantile Improvement

### Expected Quantile Improvement

```{r infill}
ctrl = setMBOControlInfill(ctrl, crit = crit.aei)
```


```{r term}
ctrl = setMBOControlTermination(ctrl, iters = 6)
```

For simplification we will let MBO automatically decide for the regression method and the initial design.
As the parameter space is purely numeric MBO will use Kriging, which is exactly what we want.

```{r run}
# Kriging can create a lot of console output, which we want tu surpress here:
configureMlr(on.learner.warning = "quiet", show.learner.output = FALSE)
res = mbo(obj.fun, control = ctrl, show.info = FALSE)
res
```


### Augmented Expected Improvement
